on:
  pull_request:
    paths-ignore:
      - "**.md"
      - "docs/**"
      - "examples/**"
  push:
    branches: [master]
    paths-ignore:
      - "**.md"
      - "examples/**"
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read

env:
  IBM_TELEMETRY_DISABLED: true

jobs:
  detect:
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'push' || github.event_name == 'pull_request'
    runs-on: macos-15
    outputs:
      docs_only: ${{ steps.compute.outputs.docs_only }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 2
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          base: ${{ github.ref }}
          filters: |
            docs:
              - "docs/**"
              - "**.md"
              - "examples/**"
            src:
              - "src/**"
              - "tests/**"
              - "tests-svelte3/**"
              - "tests-svelte5/**"
      - id: compute
        run: |
          if [ "${{ steps.filter.outputs.docs }}" == "true" ] && [ "${{ steps.filter.outputs.src }}" != "true" ]; then
            echo "docs_only=true" >> $GITHUB_OUTPUT
          else
            echo "docs_only=false" >> $GITHUB_OUTPUT
          fi

  lint:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v6
      - uses: oven-sh/setup-bun@v2
      - run: bun ci
      - run: bunx biome ci --error-on-warnings

  test-svelte4:
    needs: [lint, detect]
    if: needs.detect.outputs.docs_only != 'true'
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v6
      - uses: oven-sh/setup-bun@v2
      - run: bun ci

      - name: Generate types
        run: bun run build:docs

      - name: Test Svelte 4 Types
        run: bun run test:types

      - name: Test Svelte 4
        run: bun --bun run test

  test-svelte3:
    needs: [lint, detect]
    if: needs.detect.outputs.docs_only != 'true'
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v6
      - uses: oven-sh/setup-bun@v2
      - run: bun ci

      - name: Setup Svelte 3
        run: |
          cd tests-svelte3
          bun ci

      - name: Generate types
        run: bun run build:docs

      - name: Test Svelte 3 Types
        run: |
          cd tests-svelte3
          bun run test:types

      - name: Test Svelte 3
        run: |
          cd tests-svelte3
          bun --bun run test

  test-svelte5:
    needs: [lint, detect]
    if: needs.detect.outputs.docs_only != 'true'
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v6
      - uses: oven-sh/setup-bun@v2
      - run: bun ci

      - name: Setup Svelte 5
        run: |
          cd tests-svelte5
          bun ci

      - name: Generate types
        run: bun run build:docs

      - name: Test Svelte 5 Types
        run: |
          cd tests-svelte5
          bun run test:types

      - name: Test Svelte 5
        run: |
          cd tests-svelte5
          bun --bun run test

  types:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v6
      - uses: oven-sh/setup-bun@v2
      - run: bun ci

      - name: Build docs
        run: bun run build:docs

      - run: bun run test:src-types
      - run: bun run test:types

  deploy-docs:
    if: always() && (github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/master') && needs.lint.result == 'success' && needs.types.result == 'success' && (needs.test-svelte4.result == 'success' || (needs.test-svelte4.result == 'skipped' && needs.detect.outputs.docs_only == 'true'))
    needs: [lint, test-svelte4, types, detect]
    runs-on: macos-15
    steps:
      - name: Trigger deploy
        env:
          deploy_url: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
        run: curl -f "$deploy_url"
